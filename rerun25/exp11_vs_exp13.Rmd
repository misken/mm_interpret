---
title: "exp11_results"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(kableExtra)
```
# exp11 vs exp13

Is predictive accuracy impacted by the scenario grid size? I would think that
errors should be smaller for exp13 (larger scenario grid used to fit models.)

## Load results

```{r read_results}
exp11_ldr_metrics <- read.csv("exp11/exp11_ldr_metrics.csv", stringsAsFactors = TRUE)
exp11_pp_metrics <- read.csv("exp11/exp11_pp_metrics.csv", stringsAsFactors = TRUE)
exp11_obs_metrics <- read.csv("exp11/exp11_obs_metrics.csv", stringsAsFactors = TRUE)

exp13_ldr_metrics <- read.csv("exp13/exp13_ldr_metrics.csv", stringsAsFactors = TRUE)
exp13_pp_metrics <- read.csv("exp13/exp13_pp_metrics.csv", stringsAsFactors = TRUE)
exp13_obs_metrics <- read.csv("exp13/exp13_obs_metrics.csv", stringsAsFactors = TRUE)

# Combine
exp11_metrics <- rbind(exp11_ldr_metrics, exp11_pp_metrics, exp11_obs_metrics)
exp11_metrics$exp <- 'exp11'

exp13_metrics <- rbind(exp13_ldr_metrics, exp13_pp_metrics, exp13_obs_metrics)
exp13_metrics$exp <- 'exp13'

metrics <- rbind(exp11_metrics, exp13_metrics)

rm(exp11_ldr_metrics, exp13_ldr_metrics)
rm(exp11_pp_metrics, exp13_pp_metrics)
rm(exp11_obs_metrics, exp13_obs_metrics)
rm(exp11_metrics, exp13_metrics)
```

## Recode factors

```{r}
metrics$model <- recode_factor(metrics$model, 
                                      lassocv="lasso",
                                      lm="lm",
                                      poly="poly",
                                      rf="rf",
                                      nn="nnet",
                                      svr="svr")


metrics$measure_nice <- recode_factor(metrics$measure, 
                                      occmean="mean occupancy",
                                      occp95="95%ile occupancy",
                                      probblocked="probability blocked",
                                      condmeantimeblocked="conditional mean time blocked")

metrics$unit_nice <- recode_factor(metrics$unit, 
                                      obs="Observation",
                                      ldr="LDR",
                                      pp="Postpartum"
                                      )
```


## Aggregated performance over folds

To start, let's look at aggregated model performance over the 5 folds of the k-crossfold
validation process. A few notes:

* filtered out the pure queueing approximations for now (i.e. I'm only included fitted models)
* for occupancy statistics and conditional mean wait time we use MAPE
* for probability of blocking we use MAE (more relevant and easier to interpret)

### Overall aggregation

```{r aggregation}
metrics_agg <- metrics %>% 
  group_by(exp, unit, unit_nice, measure, measure_nice, qdata, model) %>% 
  summarize(
    train_mape = mean(train_mean_absolute_percentage_error),
    test_mape = mean(test_mean_absolute_percentage_error),
    train_mae = mean(train_mean_absolute_error),
    test_mae = mean(test_mean_absolute_error)
    
  )
```

## Compute differences

Now we need to split this dataframe back out into exp11 and exp13 versions to make it easy to subtract the 
error metrics.

```{r}
exp11_metrics_agg <- metrics_agg %>% 
  filter(exp == 'exp11')

exp13_metrics_agg <- metrics_agg %>% 
  filter(exp == 'exp13')
```

Now join the two identically structued tables.

exp11_exp13_metrics_agg <- 

```{r}
exp11_exp13_metrics_agg <- exp11_metrics_agg %>% inner_join(exp13_metrics_agg, by = c('unit', 'unit_nice', 'measure', 'measure_nice', 'qdata', 'model'),
                                 suffix = c('11', '13'))
```

Compute difference for mape

```{r}
exp11_exp13_metrics_agg <- exp11_exp13_metrics_agg %>% 
  mutate(
    test_mape_diff = test_mape13 - test_mape11,
    test_mae_diff = test_mae13 - test_mae11,
    train_mape_diff = test_mape13 - test_mape11,
    train_mae_diff = test_mae13 - test_mae11
  )
```

```{r ldr_occmean_mape}
plt_ldr_occmean_mape_diff <- exp11_exp13_metrics_agg %>% 
  filter(unit == 'ldr',
         qdata != 'onlyq', 
         model %in% c('lasso', 'lm', 'poly', 'nnet', 'rf', 'svr'),
         measure == 'occmean') %>% 
  ggplot() +
  geom_point(aes(x=model, y=test_mape_diff, color=qdata, shape=qdata), 
             size=4) +
  labs(
    title = "LDR - mean occupancy",
    subtitle = "Impact of larger scenario grid",
    caption = NULL,
    tag = NULL,
    x = "Model type",
    y = "Change in MAPE",
    colour = "Feature set",
  ) + 
    scale_colour_discrete(name  ="Queueing features",
                            breaks=c("noq", "basicq", "q"),
                            labels=c("None", "Basic", "Advanced")) +
    scale_shape_discrete(name  ="Queueing features",
                           breaks=c("noq", "basicq", "q"),
                            labels=c("None", "Basic", "Advanced")) + 
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

plt_ldr_occmean_mape_diff
ggsave('plt_ldr_occmean_mape_diff.png')
```

```{r ldr_occmean_train_mape}
plt_ldr_occmean_train_mape_diff <- exp11_exp13_metrics_agg %>% 
  filter(unit == 'ldr',
         qdata != 'onlyq', 
         model %in% c('lasso', 'lm', 'poly', 'nnet', 'rf', 'svr'),
         measure == 'occmean') %>% 
  ggplot() +
  geom_point(aes(x=model, y=train_mape_diff, color=qdata, shape=qdata), 
             size=4) +
  labs(
    title = "LDR - mean occupancy",
    subtitle = "Impact of larger scenario grid",
    caption = NULL,
    tag = NULL,
    x = "Model type",
    y = "Change in MAPE",
    colour = "Feature set",
  ) + 
    scale_colour_discrete(name  ="Queueing features",
                            breaks=c("noq", "basicq", "q"),
                            labels=c("None", "Basic", "Advanced")) +
    scale_shape_discrete(name  ="Queueing features",
                           breaks=c("noq", "basicq", "q"),
                            labels=c("None", "Basic", "Advanced")) + 
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

plt_ldr_occmean_train_mape_diff
ggsave('plt_ldr_occmean_train_mape_diff.png')
```

```{r ldr_probblocked_mape}
plt_ldr_probblocked_mae_diff <- exp11_exp13_metrics_agg %>% 
  filter(unit == 'ldr',
         qdata != 'onlyq', 
         model %in% c('lasso', 'lm', 'poly', 'nnet', 'rf', 'svr'),
         measure == 'probblocked') %>% 
  ggplot() +
  geom_point(aes(x=model, y=test_mae_diff, color=qdata, shape=qdata), 
             size=4) +
  labs(
    title = "LDR - probability blocked",
    subtitle = "Impact of larger scenario grid",
    caption = NULL,
    tag = NULL,
    x = "Model type",
    y = "Change in MAE",
    colour = "Feature set",
  ) + 
    scale_colour_discrete(name  ="Queueing features",
                            breaks=c("noq", "basicq", "q"),
                            labels=c("None", "Basic", "Advanced")) +
    scale_shape_discrete(name  ="Queueing features",
                           breaks=c("noq", "basicq", "q"),
                            labels=c("None", "Basic", "Advanced")) + 
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

plt_ldr_probblocked_mae_diff
ggsave('plt_ldr_probblocked_mae_diff.png')
```

```{r pp_occp95_mape}
plt_pp_occp95_mape_diff <- exp11_exp13_metrics_agg %>% 
  filter(unit == 'pp',
         qdata != 'onlyq', 
         model %in% c('lasso', 'lm', 'poly', 'nnet', 'rf', 'svr'),
         measure == 'occp95') %>% 
  ggplot() +
  geom_point(aes(x=model, y=test_mape_diff, color=qdata, shape=qdata), 
             size=4) +
  labs(
    title = "PP - 95%ile occupancy",
    subtitle = "Impact of larger scenario grid",
    caption = NULL,
    tag = NULL,
    x = "Model type",
    y = "Change in MAPE",
    colour = "Feature set",
  ) + 
    scale_colour_discrete(name  ="Queueing features",
                            breaks=c("noq", "basicq", "q"),
                            labels=c("None", "Basic", "Advanced")) +
    scale_shape_discrete(name  ="Queueing features",
                           breaks=c("noq", "basicq", "q"),
                            labels=c("None", "Basic", "Advanced")) + 
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

plt_pp_occp95_mape_diff
ggsave('plt_pp_occp95_mape_diff.png')
```